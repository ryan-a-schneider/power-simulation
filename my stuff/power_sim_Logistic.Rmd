---
title: "Your Document Title"
author: "Document Author"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: cerulean
    highlight: pygments
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: no
  word_document:
    toc: yes
    toc_depth: '3'
---

# Logistic Regression Power Simulation

## I. Generate Data

Kurz's original code was a single vector of data because he was not doing a group comparison in this vignette. I am, so it needs to be switched to resemble the tibble for the linear data.

```{r}

pacman::p_load(brms, easystats, tidyverse, janitor, flextable)

set.seed(3)

# set sample size
n=50

# set parameters for the DGP
probOffer_structured=.7
probOffer_UNstructured=.4


d_logistic <-tibble(group = rep(c("structured", "unstructured"), each = n)) |>  
  mutate(treatment = ifelse(group == "structured", 0, 1),
         y         = ifelse(group == "structured", 
                                      purrr::rbernoulli(n=n, p=probOffer_structured), 
                                      purrr::rbernoulli(n=n, p=probOffer_UNstructured))) |> 
  mutate(y=ifelse(y==TRUE, 1, 0))

# check
d_logistic |> filter(group=="structured") |> janitor::tabyl(y)
d_logistic |> filter(group=="unstructured") |> janitor::tabyl(y)

```

## II. Model Data

Model the above data with a logistic regression to get estimates on the proportion.

```{r message=FALSE, warning=FALSE, results='hide'}

test=glm(y ~ treatment, data = d_logistic, family = "binomial")
parameters(test)


fit_logreg <-brm(data = d_logistic, 
                 family = binomial,
                 formula =  y | trials(1) ~ 1 + treatment,
                 prior = c(prior(normal(0, 3), class = Intercept),
                           prior(student_t(3, 0, 4), class = b)),
                 seed = 3, file = here::here("fitted models", "Logistic_model"))


```

### Check the parameter estimates and HDI's

```{r}

library(gameofthrones)

# easystats method
plot(bayestestR::hdi(fit_logreg))+
  scale_fill_got_d(option="white_walkers")

ropetest=rope(fit_logreg)
plot(ropetest, rope_color = "grey70") + 
  scale_fill_got_d(option = "white_walkers")


# Kurz's method
# extract draws from the fitted model's posterior, then plot
posterior_samples(fit_logreg) %>% 
  ggplot(aes(x = b_treatment)) +
  geom_density(fill = "grey25", size = 0)
```

This shows that the posterior's location, and what values are credible. But this is one time. Need to run simulations to see what things come out to be with many, many models.

## III. Run Initial Simulation

```{r results='hide'}

# set sample size
n_sample=50

# set number of simulations
n_simulations=200

# set parameters for the DGP. LEAVE THESE ALONE ONCE SET
probOffer_structured=.7
probOffer_UNstructured=.4




# Load function  
sim_data_fit <- function(seed, n) {
 
   # GENERATE DATA 
  set.seed(seed)
  
  d <- tibble(group = rep(c("structured", "unstructured"), each = n_sample)) |>  
  mutate(treatment = ifelse(group == "structured", 0, 1),
         y         = ifelse(group == "structured", 
                                      purrr::rbernoulli(n=n, p=probOffer_structured), 
                                      purrr::rbernoulli(n=n, p=probOffer_UNstructured))) |> 
  mutate(y=ifelse(y==TRUE, 1, 0))
  
  
  # RUN SIMULATIONS
  update(fit_logreg,
         newdata = d,
         seed = seed) |>  
  model_parameters(ci_method = "HDI", ci=.89) |> as_tibble() |> select(1,2,4:5)

}
 

# Run simulation

tictoc::tic()

sim1_logistic <-
  tibble(seed = 1:n_sample) %>% 
  mutate(ci = map(seed, sim_data_fit, n = n_simulations)) |>
  unnest()

tictoc::toc()
```

## IV. Check Results

```{r}
# Plot HDI's
sim1_logistic |>  
  ggplot(aes(x = seed, ymin = CI_low, ymax = CI_high)) +
  geom_hline(yintercept = c(.25, .5), color = "white") +
  geom_linerange() +
  xlab("seed (i.e., simulation index)") #+
  scale_y_continuous("probability of hitting the ball", limits = c(0, 1))

  

# Summarize power
sim1_logistic |>  
  mutate(width = CI_high - CI_low) |>  
  summarise('conventional power' = mean(CI_high < .5), # NO IDEA WHAT THIS LINE IS FOR
            'mean width'         = mean(width),
            'width below .25'    = mean(width < .25))
```

## V. Run Large-Scale Simulation

```{r}

# set sample size
n_sample=50

# set number of simulations
n_simulations=1500



tictoc::tic()

sim1_logistic <-
  tibble(seed = 1:n_sample) %>% 
  mutate(ci = map(seed, sim_data_fit, n = n_simulations)) |>
  unnest()

tictoc::toc()
```
